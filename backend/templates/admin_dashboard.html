<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {background:#f3f5f8;}
        .dashboard-card { max-width:1400px; margin:48px auto; padding:34px 28px; background:#fff; border-radius:26px; box-shadow:0 4px 28px #0002; }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .card-head-title { font-size:2.12em; font-weight:700; margin-bottom:0; }
        .card-head-right { display:flex; flex-direction:column; align-items:flex-end; gap:7px; }
        .tab-bar { display:flex; gap:10px; margin:10px 0 20px 0; border-bottom:2px solid #e3e4e8; }
        .tab-btn { padding:7px 32px 10px 32px; border:none; background:none; font-size:1.13em; font-weight:560; color:#444; cursor:pointer; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .15s ease; }
        .tab-btn.active { color:#195cff; border-bottom:3px solid #195cff; background:none; }
        .tab-content { margin-top:18px; }
        .metric-row { display:flex; gap:36px; justify-content:space-between; }
        .metric-box { flex:1 1 0; background:#fff; border:1.5px solid #ddd; border-radius:12px; padding:26px 16px 24px 16px; box-sizing:border-box; display:flex; flex-direction:row; align-items:center; gap:18px;}
        .box-left { width:41%; min-width:210px; display:flex; flex-direction:column; align-items:center; }
        .box-right { width:59%; min-width:310px; }
        .donut-box { width:158px; height:158px; position:relative; }
        .donut-label { position:absolute; left:0; top:45px; width:158px; text-align:center; pointer-events:none; }
        .donut-label .number { font-size:2.15em; font-weight:700; }
        .donut-label .desc { font-size:1em; color:#555; line-height:1.18; }
        .metric-title { font-size:1.08em; font-weight:530; margin-bottom:9px; }
        .bar-label { font-size:1.02em; font-weight:650; color:#2384ed; margin-bottom:12px; }

        .account-actions { display:flex; gap:10px; align-items:center; }
        .btn-change { background:#0d6efd; color:#fff; }
        .btn-delete { background:#dc3545; color:#fff; }

        /* 계정관리 헤더 영역 */
        .account-header { display:flex; justify-content:flex-end; align-items:center; margin-bottom:10px; }
        .btn-create { background:#198754; color:#fff; }

        .modal-dialog { max-width: 520px; }
    </style>
</head>
<body>
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-head-title">관리자 Dashboard</div>
            <div class="card-head-right">
                <form method="post" action="/admin_logout">
                    <button type="submit" class="btn btn-secondary" style="font-size:1.01em;">로그아웃</button>
                </form>
            </div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn" id="tab_monitoring_btn" onclick="showTab('monitoring');return false;">모니터링</button>
            <button class="tab-btn" id="tab_user_btn" onclick="showTab('user');return false;">사용자 세션</button>
            <button class="tab-btn" id="tab_account_btn" onclick="showTab('account');return false;">계정관리</button>
        </div>

        <div class="tab-content" id="tab_monitoring">
            <div class="metric-row">
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 CPU 사용률</div>
                        <div class="donut-box">
                            <canvas id="cpuDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_cpu_percent) }}%</div>
                                <div class="desc">Used {{ "%0.1f"|format(used_cores) }} / {{ total_cores }} Core</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 CPU 사용률 Top 5</div>
                        <canvas id="cpuBar" width="310" height="210"></canvas>
                    </div>
                </div>
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 메모리 사용률</div>
                        <div class="donut-box">
                            <canvas id="memDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_mem_percent) }}%</div>
                                <div class="desc">Used {{ "%.1f"|format(mem_used_gb) }} / {{ "%.1f"|format(mem_total_gb) }} GB</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 메모리 사용률 Top 5</div>
                        <canvas id="memBar" width="310" height="210"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab_user" style="display:none;">
            <table class="table table-bordered" style="width:100%;margin-top:28px;">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>상태</th>
                        <th>최근 접속시간</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in user_status_list %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            {% if user.status == "ONLINE" %}
                                <span style="color:green;font-weight:600;">ONLINE</span>
                            {% else %}
                                <span style="color:#666;">OFFLINE</span>
                            {% endif %}
                        </td>
                        <td>{{ user.recent_time }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="tab-content" id="tab_account" style="display:none;">
            <!-- 계정관리 상단 우측에 신규 계정 생성 버튼 -->
            <div class="account-header">
                <button type="button" class="btn btn-sm btn-create" onclick="openCreateAccountModal()">신규 계정 생성</button>
            </div>
            <table class="table table-bordered" style="width:100%;margin-top:10px;">
                <thead>
                    <tr>
                        <th style="width:40%;">아이디</th>
                        <th style="width:60%;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_accounts_list %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            <div class="account-actions">
                                <button type="button" class="btn btn-sm btn-change" onclick="openPasswordModal('{{ user.username }}')">비밀번호 변경</button>
                                <form method="post" action="/admin_account_delete" class="d-inline" onsubmit="return confirmDelete('{{ user.username }}')">
                                    <input type="hidden" name="username" value="{{ user.username }}">
                                    <button type="submit" class="btn btn-sm btn-delete">계정 삭제</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if all_accounts_list|length == 0 %}
                    <tr>
                        <td colspan="2" class="text-center" style="color:#777;">등록된 계정이 없습니다</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 비밀번호 변경 모달: 바깥 클릭/ESC로 닫히지 않도록 설정 -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/admin_account_change_password" onsubmit="return validatePasswordChange()">
            <div class="modal-header">
              <h5 class="modal-title" id="passwordModalLabel">비밀번호 변경</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="username" id="pwdChangeUsername">
              <div class="mb-3">
                <label class="form-label">새 비밀번호</label>
                <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="새 비밀번호를 입력하세요" required>
              </div>
              <div class="mb-3">
                <label class="form-label">새 비밀번호 확인</label>
                <input type="password" class="form-control" id="newPasswordConfirm" name="new_password_confirm" placeholder="새 비밀번호를 다시 입력하세요" required>
              </div>
              <div id="pwdError" class="text-danger" style="display:none;">비밀번호가 일치하지 않습니다.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-primary">변경</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 신규 계정 생성 모달: 바깥 클릭/ESC로 닫히지 않음 -->
    <div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/admin_account_create" onsubmit="return validateCreateAccount()">
            <div class="modal-header">
              <h5 class="modal-title" id="createAccountModalLabel">신규 계정 생성</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">아이디</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="createUsername" name="username" placeholder="아이디 입력" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="checkUsernameDup()">아이디 확인</button>
                </div>
                <div id="createUsernameHelp" class="form-text">아이디 중복 여부를 확인하세요.</div>
                <div id="createUsernameError" class="text-danger" style="display:none;"></div>
                <div id="createUsernameOk" class="text-success" style="display:none;"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-control" id="createPassword" name="password" placeholder="비밀번호 입력" required>
              </div>
              <div class="mb-3">
                <label class="form-label">비밀번호 확인</label>
                <input type="password" class="form-control" id="createPasswordConfirm" name="password_confirm" placeholder="비밀번호 재입력" required>
              </div>
              <div id="createPwdError" class="text-danger" style="display:none;">비밀번호가 일치하지 않습니다.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-success">생성</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ========== 기존 스크립트 ======
    function showTab(name) {
        document.getElementById('tab_monitoring').style.display = (name=='monitoring') ? 'block' : 'none';
        document.getElementById('tab_user').style.display = (name=='user') ? 'block' : 'none';
        document.getElementById('tab_account').style.display = (name=='account') ? 'block' : 'none';

        document.getElementById('tab_monitoring_btn').classList.toggle('active', name=='monitoring');
        document.getElementById('tab_user_btn').classList.toggle('active', name=='user');
        document.getElementById('tab_account_btn').classList.toggle('active', name=='account');

        location.hash = '#' + name;
    }

    window.onload = function() {
        var hash = location.hash.replace('#', '');
        if (hash === 'user') {
            showTab('user');
        } else if (hash === 'account') {
            showTab('account');
        } else {
            showTab('monitoring');
        }
    };

    let passwordModal, createAccountModal;

    // 아이디 중복확인 상태 관리
    const UsernameCheckState = {
      Unchecked: 'unchecked',   // 확인 안함
      Available: 'available',   // 사용 가능
      Duplicate: 'duplicate',   // 중복
      Error: 'error'            // 확인 중 오류
    };
    let createUsernameState = UsernameCheckState.Unchecked;
    let lastCheckedUsername = '';

    document.addEventListener('DOMContentLoaded', function() {
        const pwdModalEl = document.getElementById('passwordModal');
        passwordModal = new bootstrap.Modal(pwdModalEl);
        const createModalEl = document.getElementById('createAccountModal');
        createAccountModal = new bootstrap.Modal(createModalEl);

        // 아이디 입력이 바뀌면 상태를 초기화
        const usernameInput = document.getElementById('createUsername');
        usernameInput.addEventListener('input', () => {
            if (usernameInput.value.trim() !== lastCheckedUsername) {
                resetUsernameCheckUI();
                createUsernameState = UsernameCheckState.Unchecked;
            }
        });
    });

    function resetUsernameCheckUI() {
        document.getElementById('createUsernameError').style.display = 'none';
        document.getElementById('createUsernameOk').style.display = 'none';
        document.getElementById('createUsernameError').innerText = '';
        document.getElementById('createUsernameOk').innerText = '';
    }

    function openPasswordModal(username) {
        document.getElementById('pwdChangeUsername').value = username;
        document.getElementById('newPassword').value = '';
        document.getElementById('newPasswordConfirm').value = '';
        document.getElementById('pwdError').style.display = 'none';
        passwordModal.show();
    }

    function validatePasswordChange() {
        const pwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('newPasswordConfirm').value;
        if (pwd !== confirmPwd) {
            document.getElementById('pwdError').style.display = 'block';
            return false;
        }
        return true;
    }

    function confirmDelete(username) {
        return confirm(username + " 계정을 정말 삭제하시겠습니까?");
    }

    // 신규 계정 생성
    function openCreateAccountModal() {
        document.getElementById('createUsername').value = '';
        document.getElementById('createPassword').value = '';
        document.getElementById('createPasswordConfirm').value = '';
        resetUsernameCheckUI();
        document.getElementById('createPwdError').style.display = 'none';
        createUsernameState = UsernameCheckState.Unchecked;
        lastCheckedUsername = '';
        createAccountModal.show();
    }

    // 핵심! 아이디 & 비밀번호 동시 병렬 검사(둘 다 오류 나오면 둘 다 보여줌)
    function validateCreateAccount() {
        const pwd = document.getElementById('createPassword').value;
        const confirmPwd = document.getElementById('createPasswordConfirm').value;
        const errEl = document.getElementById('createUsernameError');
        const pwdErrEl = document.getElementById('createPwdError');
        let valid = true;

        // 아이디 메시지: 미확인/중복/에러 다 처리
        if (createUsernameState === UsernameCheckState.Unchecked) {
            errEl.innerText = '아이디 확인을 하십시오';
            errEl.style.display = 'block';
            valid = false;
        } else if (createUsernameState === UsernameCheckState.Duplicate) {
            errEl.innerText = '중복된 아이디입니다';
            errEl.style.display = 'block';
            valid = false;
        } else if (createUsernameState === UsernameCheckState.Error) {
            errEl.innerText = '아이디 확인 중 오류가 있습니다. 다시 확인하세요.';
            errEl.style.display = 'block';
            valid = false;
        } else {
            errEl.style.display = 'none';
        }

        // 비밀번호 메시지: 미입력/불일치
        if (!pwd) {
            pwdErrEl.innerText = '비밀번호를 입력하세요';
            pwdErrEl.style.display = 'block';
            valid = false;
        } else if (pwd !== confirmPwd) {
            pwdErrEl.innerText = '비밀번호가 일치하지 않습니다.';
            pwdErrEl.style.display = 'block';
            valid = false;
        } else {
            pwdErrEl.style.display = 'none';
        }

        return valid;
    }

    async function checkUsernameDup() {
        const username = document.getElementById('createUsername').value.trim();
        const errEl = document.getElementById('createUsernameError');
        const okEl = document.getElementById('createUsernameOk');
        errEl.style.display = 'none';
        okEl.style.display = 'none';

        if (!username) {
            createUsernameState = UsernameCheckState.Unchecked;
            errEl.innerText = '아이디를 입력하세요.';
            errEl.style.display = 'block';
            return;
        }

        try {
            const resp = await fetch('/admin_account_check_username?username=' + encodeURIComponent(username), { method: 'GET' });
            if (!resp.ok) throw new Error('network error');
            const data = await resp.json();
            lastCheckedUsername = username;

            if (data.exists) {
                createUsernameState = UsernameCheckState.Duplicate;
                errEl.innerText = '중복된 아이디입니다';
                errEl.style.display = 'block';
            } else {
                createUsernameState = UsernameCheckState.Available;
                okEl.innerText = '사용 가능한 아이디입니다.';
                okEl.style.display = 'block';
                errEl.style.display = 'none';
            }
        } catch (e) {
            createUsernameState = UsernameCheckState.Error;
            errEl.innerText = '확인 중 오류가 발생했습니다.';
            errEl.style.display = 'block';
        }
    }

    // Charts
    Chart.defaults.font.size = 15; Chart.defaults.plugins.legend.display = false;

    new Chart(document.getElementById('cpuDonut'), {
      type: 'doughnut',
      data: { labels:["Used","Unused"],datasets:[{ 
          data:[{{ "%0.1f"|format(total_cpu_percent) }},100-{{ "%0.1f"|format(total_cpu_percent) }}],
          backgroundColor: ["#2366f2","#e9ecef"], borderWidth:0 }] },
      options: { cutout:'74%' }
    });

    new Chart(document.getElementById('cpuBar'), {
      type: 'bar',
      data: {
        labels: [{% for node, cpu in cpu_top5 %}"{{ node }}"{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{ data: [{% for node, cpu in cpu_top5 %}{{ "%0.1f"|format(cpu) }}{% if not loop.last %},{% endif %}{% endfor %}], backgroundColor:"#2366f2" }]
      },
      options: {
        responsive: false,
        indexAxis: 'y',
        scales: {
          x: { min: 0, max: 100, grid: {display: true},
            ticks: { stepSize:20, font:{size:14}, callback: function(value) { return value + '%'; } } },
          y: { title: {display: false},
            ticks: { font: {size:13}, padding:5, autoSkip: false, maxRotation:0, minRotation:0 } }
        }
      }
    });

    new Chart(document.getElementById('memDonut'), {
      type: 'doughnut',
      data: { labels:["Used","Unused"],datasets:[{ 
          data:[{{ "%0.1f"|format(total_mem_percent) }},100-{{ "%0.1f"|format(total_mem_percent) }}],
          backgroundColor: ["#59bf77","#e9ecef"], borderWidth:0 }] },
      options: { cutout:'74%' }
    });

    new Chart(document.getElementById('memBar'), {
      type: 'bar',
      data: {
        labels: [{% for node, mem in mem_top5 %}"{{ node }}"{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{ data: [{% for node, mem in mem_top5 %}{{ "%0.1f"|format(mem) }}{% if not loop.last %},{% endif %}{% endfor %}], backgroundColor:"#59bf77" }]
      },
      options: {
        responsive: false,
        indexAxis: 'y',
        scales: {
          x: { min: 0, max: 100, grid: {display:true},
            ticks: { stepSize:20, font:{size:14}, callback: function(value) { return value + '%'; } } },
          y: { title: {display: false},
            ticks: { font: {size:13}, padding:5, autoSkip: false, maxRotation:0, minRotation:0 } }
        }
      }
    });
    </script>
</body>
</html>

