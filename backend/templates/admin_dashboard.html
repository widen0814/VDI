<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {background:#f3f5f8;}
        .dashboard-card {
            max-width:1400px;
            margin:48px auto;
            padding:34px 28px;
            background:#fff;
            border-radius:26px;
            box-shadow:0 4px 28px #0002;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card-head-title {
            font-size:2.12em;
            font-weight:700;
            margin-bottom:0;
        }
        .card-head-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap:7px;
        }
        .logout-btn-area {
            display: flex;
            align-items: center;
        }
        .tab-bar {
            display: flex;
            gap: 10px;
            margin: 10px 0 20px 0;
            border-bottom: 2px solid #e3e4e8;
        }
        .tab-btn {
            padding: 7px 32px 10px 32px;
            border: none;
            background: none;
            font-size: 1.13em;
            font-weight: 560;
            color: #444;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: border 0.2s;
        }
        .tab-btn.active {
            color: #195cff;
            border-bottom: 3px solid #195cff;
            background: none;
        }
        .tab-content {margin-top:18px;}
        .metric-row {
            display: flex;
            gap: 36px;
            justify-content: space-between;
        }
        .metric-box {
            flex: 1 1 0;
            background: #fff;
            border: 1.5px solid #ddd;
            border-radius: 12px;
            padding: 26px 16px 24px 16px;
            box-sizing: border-box;
            display: flex; flex-direction: row; align-items: center; min-width: 520px;
        }
        .box-left {width:41%;min-width:210px;display:flex;flex-direction:column;align-items:center;}
        .box-right {width:59%; min-width:310px;}
        .donut-box {width:158px;height:158px;position:relative;}
        .donut-label {position:absolute;left:0;top:45px;width:158px;text-align:center;pointer-events:none;}
        .donut-label .number {font-size:2.15em;font-weight:700;}
        .donut-label .desc {font-size:1em;color:#555;line-height:1.18;}
        .metric-title {font-size:1.08em;font-weight:530;margin-bottom:9px;}
        .bar-label {font-size:1.02em;font-weight:650;color:#2384ed;margin-bottom:12px;}
    </style>
</head>
<body>
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-head-title">관리자 Dashboard</div>
            <div class="card-head-right">
                <form method="post" action="/admin_logout">
                    <button type="submit" class="btn btn-secondary" style="font-size:1.01em;">로그아웃</button>
                </form>
            </div>
        </div>
        <!-- 탭 메뉴 -->
        <div class="tab-bar">
            <button class="tab-btn" id="tab_monitoring_btn" onclick="showTab('monitoring');return false;">모니터링</button>
            <button class="tab-btn" id="tab_user_btn" onclick="showTab('user');return false;">유저관리</button>
        </div>
        <!-- 모니터링 탭 -->
        <div class="tab-content" id="tab_monitoring">
            <div class="metric-row">
                <!-- CPU Box -->
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 CPU 사용률</div>
                        <div class="donut-box">
                            <canvas id="cpuDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_cpu_percent) }}%</div>
                                <div class="desc">Used {{ "%0.1f"|format(used_cores) }} / {{ total_cores }} Core</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 CPU 사용률 Top 5</div>
                        <canvas id="cpuBar" width="310" height="210"></canvas>
                    </div>
                </div>
                <!-- MEM Box -->
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 메모리 사용률</div>
                        <div class="donut-box">
                            <canvas id="memDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_mem_percent) }}%</div>
                                <div class="desc">
                                    Used {{ "%.1f"|format(mem_used_gb) }} / {{ "%.1f"|format(mem_total_gb) }} GB
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 메모리 사용률 Top 5</div>
                        <canvas id="memBar" width="310" height="210"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- 유저관리 탭 -->
        <div class="tab-content" id="tab_user" style="display:none;">
            <table class="table table-bordered" style="width:100%;margin-top:28px;">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>상태</th>
                        <th>최근 접속시간</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in user_status_list %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            {% if user.status == "ONLINE" %}
                                <span style="color:green;font-weight:600;">ONLINE</span>
                            {% else %}
                                <span style="color:#666;">OFFLINE</span>
                            {% endif %}
                        </td>
                        <td>{{ user.recent_time }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
    // 탭 전환 & URL hash로 현재 탭 저장/유지 기능
    function showTab(name) {
        document.getElementById('tab_monitoring').style.display = (name=='monitoring') ? 'block' : 'none';
        document.getElementById('tab_user').style.display = (name=='user') ? 'block' : 'none';
        document.getElementById('tab_monitoring_btn').classList.toggle('active', name=='monitoring');
        document.getElementById('tab_user_btn').classList.toggle('active', name=='user');
        // 현재 탭을 location.hash에 기록
        location.hash = '#' + name;
    }

    // 페이지 로드시 hash(탭정보) 읽어서 해당 탭 보여줌
    window.onload = function() {
        var hash = location.hash.replace('#', '');
        if (hash === 'user') {
            showTab('user');
        } else {
            showTab('monitoring');
        }
    };

    // === 모니터링 탭 Chart.js 기존 코드 전체 ===
    Chart.defaults.font.size = 15; Chart.defaults.plugins.legend.display = false;

    // CPU 도넛
    new Chart(document.getElementById('cpuDonut'), {
      type: 'doughnut',
      data: { labels:["Used","Unused"],datasets:[{ 
          data:[{{ "%0.1f"|format(total_cpu_percent) }},100-{{ "%0.1f"|format(total_cpu_percent) }}], 
          backgroundColor: ["#2366f2","#e9ecef"], borderWidth:0 }] },
      options: { cutout:'74%' }
    });

    // CPU BAR
    new Chart(document.getElementById('cpuBar'), {
      type: 'bar',
      data: {
        labels: [{% for node, cpu in cpu_top5 %}"{{ node }}"{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{ data: [{% for node, cpu in cpu_top5 %}{{ "%0.1f"|format(cpu) }}{% if not loop.last %},{% endif %}{% endfor %}], backgroundColor:"#2366f2" }]
      },
      options: {
        responsive: false,
        indexAxis: 'y',
        scales: {
          x: {
            min: 0, max: 100,
            grid: {display: true},
            ticks: {
              stepSize:20, font:{size:14},
              callback: function(value) { return value + '%'; }
            }
          },
          y: {
            title: {display: false},
            ticks: {
              font: {size:13},
              padding:5,
              autoSkip: false,
              maxRotation:0,
              minRotation:0
            }
          }
        }
      }
    });

    // MEM 도넛
    new Chart(document.getElementById('memDonut'), {
      type: 'doughnut',
      data: { labels:["Used","Unused"],datasets:[{ 
          data:[{{ "%0.1f"|format(total_mem_percent) }},100-{{ "%0.1f"|format(total_mem_percent) }}], 
          backgroundColor: ["#59bf77","#e9ecef"], borderWidth:0 }] },
      options: { cutout:'74%' }
    });

    // MEM BAR
    new Chart(document.getElementById('memBar'), {
      type: 'bar',
      data: {
        labels: [{% for node, mem in mem_top5 %}"{{ node }}"{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{ data: [{% for node, mem in mem_top5 %}{{ "%0.1f"|format(mem) }}{% if not loop.last %},{% endif %}{% endfor %}], backgroundColor:"#59bf77" }]
      },
      options: {
        responsive: false,
        indexAxis: 'y',
        scales: {
          x: {
            min: 0, max: 100,
            grid: {display:true},
            ticks: {
              stepSize:20, font:{size:14},
              callback: function(value) { return value + '%'; }
            }
          },
          y: {
            title: {display: false},
            ticks: {
              font: {size:13}, padding:5, autoSkip: false,
              maxRotation:0, minRotation:0
            }
          }
        }
      }
    });
    </script>
</body>
</html>
