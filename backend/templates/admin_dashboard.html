<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {background:#f3f5f8;}
        .dashboard-card { max-width:1400px; margin:48px auto; padding:34px 28px; background:#fff; border-radius:26px; box-shadow:0 4px 28px #0002; }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .card-head-title { font-size:2.12em; font-weight:700; margin-bottom:0; }
        .card-head-right { display:flex; flex-direction:column; align-items:flex-end; gap:7px; }
        .tab-bar { display:flex; gap:10px; margin:10px 0 20px 0; border-bottom:2px solid #e3e4e8; }
        .tab-btn { padding:7px 32px 10px 32px; border:none; background:none; font-size:1.13em; font-weight:560; color:#444; cursor:pointer; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .15s ease; }
        .tab-btn.active { color:#195cff; border-bottom:3px solid #195cff; background:none; }
        .tab-content { margin-top:18px; }
        .metric-row { display:flex; gap:36px; justify-content:space-between; }
        .metric-box { flex:1 1 0; background:#fff; border:1.5px solid #ddd; border-radius:12px; padding:26px 16px 24px 16px; box-sizing:border-box; display:flex; flex-direction:row; align-items:center; }
        .box-left { width:41%; min-width:210px; display:flex; flex-direction:column; align-items:center; }
        .box-right { width:59%; min-width:310px; }
        .donut-box { width:158px; height:158px; position:relative; }
        .donut-label { position:absolute; left:0; top:45px; width:158px; text-align:center; pointer-events:none; }
        .donut-label .number { font-size:2.15em; font-weight:700; }
        .donut-label .desc { font-size:1em; color:#555; line-height:1.18; }
        .metric-title { font-size:1.08em; font-weight:530; margin-bottom:9px; }
        .bar-label { font-size:1.02em; font-weight:650; color:#2384ed; margin-bottom:12px; }
        .account-actions { display:flex; gap:10px; align-items:center; }
        .btn-change { background:#0d6efd; color:#fff; }
        .btn-delete { background:#dc3545; color:#fff; }
        .account-header { display:flex; justify-content:flex-end; align-items:center; margin-bottom:10px; }
        .btn-create { background:#198754; color:#fff; }
        .modal-dialog { max-width: 520px; }
    </style>
</head>
<body>
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-head-title">관리자 Dashboard</div>
            <div class="card-head-right">
                <form method="post" action="/admin_logout">
                    <button type="submit" class="btn btn-secondary" style="font-size:1.01em;">로그아웃</button>
                </form>
            </div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn" id="tab_monitoring_btn" onclick="showTab('monitoring');return false;">모니터링</button>
            <button class="tab-btn" id="tab_user_btn" onclick="showTab('user');return false;">사용자 세션</button>
            <button class="tab-btn" id="tab_account_btn" onclick="showTab('account');return false;">계정관리</button>
            <button class="tab-btn" id="tab_images_btn" onclick="showTab('images');return false;">데스크톱 관리</button>
        </div>

        <!-- 모니터링 -->
        <div class="tab-content" id="tab_monitoring">
            <div class="metric-row">
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 CPU 사용률</div>
                        <div class="donut-box">
                            <canvas id="cpuDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_cpu_percent) }}%</div>
                                <div class="desc">Used {{ "%0.1f"|format(used_cores) }} / {{ total_cores }} Core</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 CPU 사용률 Top 5</div>
                        <canvas id="cpuBar" width="310" height="210"></canvas>
                    </div>
                </div>
                <div class="metric-box">
                    <div class="box-left">
                        <div class="metric-title">전체 메모리 사용률</div>
                        <div class="donut-box">
                            <canvas id="memDonut" width="158" height="158"></canvas>
                            <div class="donut-label">
                                <div class="number">{{ "%0.1f"|format(total_mem_percent) }}%</div>
                                <div class="desc">Used {{ "%.1f"|format(mem_used_gb) }} / {{ "%.1f"|format(mem_total_gb) }} GB</div>
                            </div>
                        </div>
                    </div>
                    <div class="box-right">
                        <div class="bar-label">노드별 메모리 사용률 Top 5</div>
                        <canvas id="memBar" width="310" height="210"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사용자 세션 -->
        <div class="tab-content" id="tab_user" style="display:none;">
            <table class="table table-bordered" style="width:100%;margin-top:28px;">
                <thead>
                    <tr>
                        <th>아이디</th>
                        <th>상태</th>
                        <th>최근 접속시간(KST)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in user_status_list %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            {% if user.status == "ONLINE" %}
                                <span style="color:green;font-weight:600;">ONLINE</span>
                            {% else %}
                                <span style="color:#666;">OFFLINE</span>
                            {% endif %}
                        </td>
                        <td>{{ user.recent_time }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 계정관리 -->
        <div class="tab-content" id="tab_account" style="display:none;">
            <div class="account-header">
                <button type="button" class="btn btn-sm btn-create" onclick="openCreateAccountModal()">신규 계정 생성</button>
            </div>
            <table class="table table-bordered" style="width:100%;margin-top:10px;">
                <thead>
                    <tr>
                        <th style="width:40%;">아이디</th>
                        <th style="width:60%;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_accounts_list %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            <div class="account-actions">
                                <button type="button" class="btn btn-sm btn-change" onclick="openPasswordModal('{{ user.username }}')">비밀번호 변경</button>
                                <form method="post" action="/admin_account_delete" class="d-inline" onsubmit="return confirmDelete('{{ user.username }}')">
                                    <input type="hidden" name="username" value="{{ user.username }}">
                                    <button type="submit" class="btn btn-sm btn-delete">계정 삭제</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if all_accounts_list|length == 0 %}
                    <tr>
                        <td colspan="2" class="text-center" style="color:#777;">등록된 계정이 없습니다</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 데스크톱 관리 -->
        <div class="tab-content" id="tab_images" style="display:none;">
            <div class="account-header">
                <button type="button" class="btn btn-sm btn-create" onclick="openCreateImageModal()">이미지 추가</button>
            </div>
            <table class="table table-bordered" style="width:100%;margin-top:10px;">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>이미지 레퍼런스 (repo:tag)</th>
                        <th>web_port/vnc_port</th>
                        <th style="width:20%;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name, ref, web_port, vnc_port in images %}
                    <tr>
                        <td>{{ name }}</td>
                        <td>{{ ref }}</td>
                        <td>{{ web_port }}/{{ vnc_port }}</td>
                        <td>
                            <form method="post" action="/admin_images_delete" onsubmit="return confirm('이미지를 삭제하시겠습니까?');">
                                <input type="hidden" name="name" value="{{ name }}">
                                <button type="submit" class="btn btn-sm btn-delete">삭제</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if images|length == 0 %}
                    <tr>
                        <td colspan="4" class="text-center" style="color:#777;">등록된 이미지가 없습니다</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/admin_account_change_password" onsubmit="return validatePasswordChange()">
            <div class="modal-header">
              <h5 class="modal-title" id="passwordModalLabel">비밀번호 변경</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="username" id="pwdChangeUsername">
              <div class="mb-3">
                <label class="form-label">새 비밀번호</label>
                <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="새 비밀번호를 입력하세요" required>
              </div>
              <div class="mb-3">
                <label class="form-label">새 비밀번호 확인</label>
                <input type="password" class="form-control" id="newPasswordConfirm" name="new_password_confirm" placeholder="새 비밀번호를 다시 입력하세요" required>
              </div>
              <div id="pwdError" class="text-danger" style="display:none;">비밀번호가 일치하지 않습니다.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-primary">변경</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 신규 계정 생성 모달 -->
    <div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/admin_account_create" onsubmit="return validateCreateAccount()">
            <div class="modal-header">
              <h5 class="modal-title" id="createAccountModalLabel">신규 계정 생성</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">아이디</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="createUsername" name="username" placeholder="아이디 입력" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="checkUsernameDup()">아이디 확인</button>
                </div>
                <div id="createUsernameHelp" class="form-text">아이디 중복 여부를 확인하세요.</div>
                <div id="createUsernameError" class="text-danger" style="display:none;"></div>
                <div id="createUsernameOk" class="text-success" style="display:none;"></div>
              </div>
              <div class="mb-3">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-control" id="createPassword" name="password" placeholder="비밀번호 입력" required>
              </div>
              <div class="mb-3">
                <label class="form-label">비밀번호 확인</label>
                <input type="password" class="form-control" id="createPasswordConfirm" name="password_confirm" placeholder="비밀번호 재입력" required>
              </div>
              <div id="createPwdError" class="text-danger" style="display:none;">비밀번호가 일치하지 않습니다.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-success">생성</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 이미지 추가 모달 -->
    <div class="modal fade" id="createImageModal" tabindex="-1" aria-labelledby="createImageModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/admin_images_create" onsubmit="return validateCreateImage()">
            <div class="modal-header">
              <h5 class="modal-title" id="createImageModalLabel">이미지 추가</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">이미지 이름</label>
                <input type="text" class="form-control" id="imageName" name="name" placeholder="예: Ubuntu-LXDE" required>
              </div>
              <div class="mb-3">
                <label class="form-label">이미지 레퍼런스</label>
                <input type="text" class="form-control" id="imageRef" name="image_ref" placeholder="예: repo/image:tag" required>
                <div class="form-text">사용자가 로그인할 때 선택 가능한 이미지 목록에 추가됩니다.</div>
              </div>
              <div class="mb-3 row">
                <div class="col">
                  <label class="form-label">웹 포트(컨테이너)</label>
                  <input type="number" class="form-control" id="imageWebPort" name="web_port" value="80" min="1" max="65535">
                  <div class="form-text">noVNC/웹 접속용 포트(예 80, 6080)</div>
                </div>
                <div class="col">
                  <label class="form-label">VNC 포트(컨테이너)</label>
                  <input type="number" class="form-control" id="imageVncPort" name="vnc_port" value="5900" min="1" max="65535">
                  <div class="form-text">VNC 서버 포트(일반적으로 5900)</div>
                </div>
              </div>
              <div id="createImageError" class="text-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-success">추가</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function showTab(name) {
        document.getElementById('tab_monitoring').style.display = (name=='monitoring') ? 'block' : 'none';
        document.getElementById('tab_user').style.display = (name=='user') ? 'block' : 'none';
        document.getElementById('tab_account').style.display = (name=='account') ? 'block' : 'none';
        document.getElementById('tab_images').style.display = (name=='images') ? 'block' : 'none';

        document.getElementById('tab_monitoring_btn').classList.toggle('active', name=='monitoring');
        document.getElementById('tab_user_btn').classList.toggle('active', name=='user');
        document.getElementById('tab_account_btn').classList.toggle('active', name=='account');
        document.getElementById('tab_images_btn').classList.toggle('active', name=='images');

        location.hash = '#' + name;
    }

    window.onload = function() {
        var hash = location.hash.replace('#', '');
        if (hash === 'user') {
            showTab('user');
        } else if (hash === 'account') {
            showTab('account');
        } else if (hash === 'images') {
            showTab('images');
        } else {
            showTab('monitoring');
        }
    };

    let passwordModal, createAccountModal, createImageModal;
    document.addEventListener('DOMContentLoaded', function() {
        passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        createAccountModal = new bootstrap.Modal(document.getElementById('createAccountModal'));
        createImageModal = new bootstrap.Modal(document.getElementById('createImageModal'));
    });

    function openPasswordModal(username) {
        document.getElementById('pwdChangeUsername').value = username;
        document.getElementById('newPassword').value = '';
        document.getElementById('newPasswordConfirm').value = '';
        document.getElementById('pwdError').style.display = 'none';
        passwordModal.show();
    }

    function validatePasswordChange() {
        const pwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('newPasswordConfirm').value;
        if (pwd !== confirmPwd) {
            document.getElementById('pwdError').style.display = 'block';
            return false;
        }
        return true;
    }

    function confirmDelete(username) {
        return confirm(username + " 계정을 정말 삭제하시겠습니까?");
    }

    function openCreateAccountModal() {
        document.getElementById('createUsername').value = '';
        document.getElementById('createPassword').value = '';
        document.getElementById('createPasswordConfirm').value = '';
        resetUsernameCheckUI();
        const pwdErr = document.getElementById('createPwdError');
        if (pwdErr) pwdErr.style.display = 'none';
        createUsernameState = UsernameCheckState.Unchecked;
        lastCheckedUsername = '';
        createAccountModal.show();
    }

    function openCreateImageModal() {
        document.getElementById('imageName').value = '';
        document.getElementById('imageRef').value = '';
        document.getElementById('imageWebPort').value = '80';
        document.getElementById('imageVncPort').value = '5900';
        document.getElementById('createImageError').style.display = 'none';
        createImageModal.show();
    }

    function validateCreateImage() {
        const name = document.getElementById('imageName').value.trim();
        const ref = document.getElementById('imageRef').value.trim();
        const webPort = document.getElementById('imageWebPort').value.trim();
        const vncPort = document.getElementById('imageVncPort').value.trim();
        const errEl = document.getElementById('createImageError');
        if (!name || !ref) {
            errEl.innerText = '이름과 이미지 레퍼런스를 입력하세요.';
            errEl.style.display = 'block';
            return false;
        }
        if (webPort && (isNaN(webPort) || webPort < 1 || webPort > 65535)) {
            errEl.innerText = '웹 포트가 유효하지 않습니다.';
            errEl.style.display = 'block';
            return false;
        }
        if (vncPort && (isNaN(vncPort) || vncPort < 1 || vncPort > 65535)) {
            errEl.innerText = 'VNC 포트가 유효하지 않습니다.';
            errEl.style.display = 'block';
            return false;
        }
        return true;
    }

    function resetUsernameCheckUI() {
        const err = document.getElementById('createUsernameError');
        const ok = document.getElementById('createUsernameOk');
        if (err) { err.style.display = 'none'; err.innerText = ''; }
        if (ok) { ok.style.display = 'none'; ok.innerText = ''; }
    }

    // 아래는 아이디 중복확인, 계정 생성 등 기존 함수 그대로 입니다.
    /* ... 이하 기존 스크립트 ... */
    </script>
</body>
</html>
